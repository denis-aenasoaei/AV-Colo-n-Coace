{% load django_bootstrap5 %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Colo-n coace - Your traveling virtual assistant</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="{% static 'img/logo.ico' %}" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
        <link href="{% static 'css/stylesstt.css' %}" rel="stylesheet" />
    </head>
    <body>
        <div class="d-flex pb-5" id="wrapper">
            <!-- Sidebar-->
            <div class="border-end bg-white" id="sidebar-wrapper">
                <div class="sidebar-heading border-bottom bg-light">Personal Tools</div>
                <div class="list-group list-group-flush">
                    <a class="list-group-item list-group-item-action list-group-item-light p-3" href="#!">My Trips</a>
                    <!-- <a class="list-group-item list-group-item-action list-group-item-light p-3" href="#!">Shortcuts</a> -->
                </div>
            </div>
            <!-- Page content wrapper-->
            <div id="page-content-wrapper">
                <!-- Top navigation-->
                <nav class="navbar navbar-expand-lg navbar-light border-bottom">
                    <div class="container-fluid">
                        <button class="btn btn-warning" id="sidebarToggle">
                          Tools
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-diamond-fill" viewBox="0 0 16 16">
                            <path d="M9.05.435c-.58-.58-1.52-.58-2.1 0L4.047 3.339 8 7.293l3.954-3.954L9.049.435zm3.61 3.611L8.708 8l3.954 3.954 2.904-2.905c.58-.58.58-1.519 0-2.098l-2.904-2.905zm-.706 8.614L8 8.708l-3.954 3.954 2.905 2.904c.58.58 1.519.58 2.098 0l2.905-2.904zm-8.614-.706L7.292 8 3.339 4.046.435 6.951c-.58.58-.58 1.519 0 2.098l2.904 2.905z"/>
                          </svg>
                        </button>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                                <li class="nav-item active"><a class="nav-link" href="{% url 'index' %}">Home</a></li>
                                <li class="nav-item"><a class="nav-link" href="{% url 'map' %}">Map</a></li>
                                <!-- <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
                                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                        <a class="dropdown-item" href="#!">Action</a>
                                        <a class="dropdown-item" href="#!">Another action</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#!">Something else here</a>
                                    </div>
                                </li> -->
                            </ul>
                        </div>
                    </div>
                </nav>
                <!-- Page content-->
                <div class="d-flex flex-column align-items-center pt-4">
                  <img src="{% static 'img/logo.png' %}" alt="logo" style="height: 10%; width: 10%">
                  <h2 class="mt-4">Welcome to 'Colo-n coace'!</h2>
                  <p>
                    Let's travel together.
                  </p>
                </div>

                <div class="page-content page-container" id="page-content">
                  <div class="padding">
                    <div class="row container d-flex justify-content-center">
                        <div class="col-md-6">
                          <div class="card card-bordered">
                            <div class="card-header">
                              <h4 class="card-title">Let's talk</h4>
                            </div>
                            <div class="ps-container ps-theme-default ps-active-y" id="chat-content" style="overflow-y: scroll !important; height:400px !important;">
                              
                              <div class="">
                                <div class="border-bottom">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16">
                                    <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/>
                                    <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
                                  </svg>
                                  <p style="display: inline-block;">Hi. Do you have a place in mind?</p>
                                  <!-- <p class="meta"><time datetime="2018">23:58</time></p> -->
                                </div>
                              </div>

                              <div class="">
                                <div class="border-bottom">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                                  </svg>
                                  <p style="display: inline-block;">Write down or hold mic and ask what you are looking for</p>
                                  <!-- <p class="meta"><time datetime="2018">00:06</time></p> -->
                                </div>
                              </div>                         

                            <div class="ps-scrollbar-x-rail" style=""><div class="" tabindex="5" style="">

                              <div class="capture-mic-box" style="display: none;">
                                <div style="display: flex;justify-content: center;">
                                    <div class="lds-ellipsis">
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                    <div class="lds-ellipsis">
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                    <!-- onclick="startRecording()"   -->
                                </div>
                                <div style="display: flex;justify-content: center;" class="voice-interpreter-box">
                                    <label>please wait. searching...</label>
                                </div>
                              </div>
                              <div id="search-results-box" style="display: none;">
                                
                              </div>

                            </div>
                          </div>
                          <div class="ps-scrollbar-y-rail" style="top: 0px; height: 0px; right: 2px;"><div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 2px;"></div>
                        </div>
                      </div>

                      <div class="bt-1 border-light">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                          <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                          <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                        </svg>
                        <input class="" type="text" placeholder="Write something">
                        <span class="">
                          <button id="btnTypeToAssistant" type="button" class="btn btn-primary" style="border-radius: 40%;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-keyboard-fill" viewBox="0 0 16 16">
                              <path d="M0 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6zm13 .25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5a.25.25 0 0 0-.25.25zM2.25 8a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 3 8.75v-.5A.25.25 0 0 0 2.75 8h-.5zM4 8.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 5 8.75v-.5A.25.25 0 0 0 4.75 8h-.5a.25.25 0 0 0-.25.25zM6.25 8a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 7 8.75v-.5A.25.25 0 0 0 6.75 8h-.5zM8 8.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 9 8.75v-.5A.25.25 0 0 0 8.75 8h-.5a.25.25 0 0 0-.25.25zM13.25 8a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5zm0 2a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5zm-3-2a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h1.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-1.5zm.75 2.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5a.25.25 0 0 0-.25.25zM11.25 6a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5zM9 6.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5A.25.25 0 0 0 9.75 6h-.5a.25.25 0 0 0-.25.25zM7.25 6a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 8 6.75v-.5A.25.25 0 0 0 7.75 6h-.5zM5 6.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 6 6.75v-.5A.25.25 0 0 0 5.75 6h-.5a.25.25 0 0 0-.25.25zM2.25 6a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h1.5A.25.25 0 0 0 4 6.75v-.5A.25.25 0 0 0 3.75 6h-1.5zM2 10.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5a.25.25 0 0 0-.25.25zM4.25 10a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h5.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-5.5z"/>
                            </svg>
                          </button>
                          <button id="btnTalkWithAssistant" type="button" class="btn btn-primary" style="border-radius: 40%;" data-bs-toggle="modal" data-bs-target="#recordVoiceModal">
                            <span class="material-icons mic-btn">mic</span>
                          </button>
                        </span>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
          </div>

        <!-- Modal -->
        <div class="modal fade" id="recordVoiceModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Listening to you...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <img src="{% static 'img/record.gif' %}" height="100" width="100" style="display: block; margin-left: auto; margin-right: auto;">
              </div>
              <div class="modal-footer">
                <button id="cancel-mic-btn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="stream-mic-btn" type="button" class="btn btn-primary" data-bs-dismiss="modal">Send</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Bootstrap core JS-->
        <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

        <!-- Core theme JS-->
        <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
        <script src="{% static 'js/scripts.js' %}"></script>
        <script src="{% static 'js/binary.min.js' %}"></script>
        <script src="{% static 'js/recorder.js' %}"></script>
        <script>
          let i = 1, recOn = false;

          function answerBot(){
            $.ajax({
                  url: "http://localhost:3700/bot",
                  method: 'get',
                  processData: false,
                  contentType: false,
                    success: function(data){
                      console.log("/results ", data, "\n")
                      const text = $('#search-results-box').html();
                      $('#search-results-box').html(text+`<p>${data}</p>`);
                    },
                    error: function(e) {
                      console.log("error: ", e)
                    },
                  });
          }

          function readSearchQuery() {

              $.ajax({
                  url: "http://localhost:3700/results",
                  method: 'get',
                  processData: false,
                  contentType: false,
                    success: function(data){
                      if (recOn) {recOn = false;}
                      console.log("/results ", data, "\n");
                      $('.capture-mic-box').hide();
                      $('#search-results-box').html(`<p>${data}</p>`)
                      $('#search-results-box').show();
                      setTimeout(()=>{
                        answerBot();
                      }, 37000);
                    },
                    error: function(e) {
                      console.log("error: ", e)
                    },
                  });
            
          }
  
          function streamMic() {
              const id = Math.random();

              if (!recOn) {
                  recOn = true;
              }
              startRecording();
              console.log("startRecording: ", recOn, i++, id);
          }

          function stopMic() {
              const id = Math.random();
              $('.capture-mic-box').show();
              $('#search-results-box').html("")
              $('#search-results-box').hide();
              
              
              stopRecording();
              console.log("startRecording: ", recOn, i++, id);

              setTimeout(()=>{

                $.ajax({
                  url: "http://localhost:3700/speech/to/text",
                  method: 'post',
                  processData: false,
                  contentType: false,
                    success: function(data){
                      if (recOn) {recOn = false;}
                      console.log("/speech/to/text ", data, "\n");

                      setTimeout(()=>{
                        readSearchQuery();
                      }, 17000)

                    },
                    error: function(e) {
                      $('.capture-mic-box').hide();
                      $('#search-results-box').html(`<p>There was an error</p>`)
                      $('#search-results-box').show();
                      if (recOn) {recOn = false;}
                      console.log("error: ", e)
                    },
                  });

              }, 2000);
             

          }

          function cancelMic() {
              const id = Math.random();
              $('.capture-mic-box').hide();
              if (recOn) {
                  recOn = false;
              }
              console.log(recOn, i++, id);
          }
  
          const captureMic = document.getElementById('btnTalkWithAssistant');
          captureMic.addEventListener('click', streamMic);

          const sendStream = document.getElementById('stream-mic-btn');
          sendStream.addEventListener('click', stopMic);

          const cancelStream = document.getElementById('cancel-mic-btn');
          cancelStream.addEventListener('click', cancelMic);
  
      </script>
    </body>
</html>
